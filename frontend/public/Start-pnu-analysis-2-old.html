<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Blank Page - DocVisionAI</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/Features-Cards-icons.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0 navbar-dark" style="background: rgb(78, 115, 223);">
            <div class="container-fluid d-flex flex-column p-0"><a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -64 640 640" width="1em" height="1em" fill="currentColor" style="font-size: 42px;">
                        <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc. -->
                        <path d="M64 96c0-35.3 28.7-64 64-64H512c35.3 0 64 28.7 64 64V352H512V96H128V352H64V96zM0 403.2C0 392.6 8.6 384 19.2 384H620.8c10.6 0 19.2 8.6 19.2 19.2c0 42.4-34.4 76.8-76.8 76.8H76.8C34.4 480 0 445.6 0 403.2zM288 160c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v48h48c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H352v48c0 8.8-7.2 16-16 16H304c-8.8 0-16-7.2-16-16V272H240c-8.8 0-16-7.2-16-16V224c0-8.8 7.2-16 16-16h48V160z"></path>
                    </svg>
                    <div class="sidebar-brand-icon rotate-n-15"></div>
                    <div class="sidebar-brand-text mx-3"><span>DocVisionAI</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="index-dash.html"><i class="fas fa-tachometer-alt" style="font-size: 13px;"></i><span>Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="profile.html"><i class="fas fa-user" style="font-size: 14px;"></i><span>Profile</span></a></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"><a class="nav-link" href="Patient-Search-only.html"><i class="fas fa-search" style="font-size: 14px;"></i><span>Patient Search</span></a><a class="nav-link" href="Start-quick-analysis-1.html"><i class="fas fa-tachometer-alt" style="font-size: 13px;"></i><span>Quick Analysis</span></a><a class="nav-link" href="Start-analysis.html"><i class="fas fa-file-medical" style="font-size: 16px;"></i><span>Start Analysis</span></a></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-expand bg-white shadow mb-4 topbar">
                    <div class="container-fluid">
                        <ul class="navbar-nav"></ul>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"></a>
                                    <div class="dropdown-menu dropdown-list dropdown-menu-end animated--grow-in">
                                        <h6 class="dropdown-header">alerts center</h6><a class="d-flex align-items-center dropdown-item" href="#">
                                            <div class="me-3">
                                                <div class="bg-primary icon-circle"><i class="fas fa-file-alt text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 12, 2019</span>
                                                <p>A new monthly report is ready to download!</p>
                                            </div>
                                        </a><a class="d-flex align-items-center dropdown-item" href="#">
                                            <div class="me-3">
                                                <div class="bg-success icon-circle"><i class="fas fa-donate text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 7, 2019</span>
                                                <p>$290.29 has been deposited into your account!</p>
                                            </div>
                                        </a><a class="d-flex align-items-center dropdown-item" href="#">
                                            <div class="me-3">
                                                <div class="bg-warning icon-circle"><i class="fas fa-exclamation-triangle text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 2, 2019</span>
                                                <p>Spending Alert: We've noticed unusually high spending for your account.</p>
                                            </div>
                                        </a><a class="text-center dropdown-item small text-gray-500" href="#">Show All Alerts</a>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"></a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">alerts center</h6><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar4.jpeg">
                                                <div class="bg-success status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Hi there! I am wondering if you can help me with a problem I've been having.</span></div>
                                                <p class="small text-gray-500 mb-0">Emily Fowler - 58m</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar2.jpeg">
                                                <div class="status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>I have the photos that you ordered last month!</span></div>
                                                <p class="small text-gray-500 mb-0">Jae Chun - 1d</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar3.jpeg">
                                                <div class="bg-warning status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Last month's report looks great, I am very happy with the progress so far, keep up the good work!</span></div>
                                                <p class="small text-gray-500 mb-0">Morgan Alvarez - 2d</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar5.jpeg">
                                                <div class="bg-success status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Am I a good boy? The reason I ask is because someone told me that people say this to all dogs, even if they aren't good...</span></div>
                                                <p class="small text-gray-500 mb-0">Chicken the Dog Â· 2w</p>
                                            </div>
                                        </a><a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                                    </div>
                                </div>
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-end" aria-labelledby="alertsDropdown"></div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><span class="d-none d-lg-inline me-2 text-gray-600 small" id="user-name"></span></a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in"><a class="dropdown-item" href="#"><i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Profile</a>
                                        <div class="dropdown-divider"></div><a class="dropdown-item" id="logoutButton" href="#"><i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Logout</a>
                                    </div>
                                </div>
                            </li>
                        </ul><button class="btn rounded-circle border-0" id="sidebarToggle-1" type="button"></button>
                    </div>
                </nav>
                <div class="container-fluid">
                    <h3 class="text-dark mb-1" style="font-weight: bold;">Upload Medical Images</h3>
                    <div class="row">
                        <div class="col-md-8 col-xxl-12" style="padding-bottom: 0px;height: 513px;margin: 0px;width: 1500px;"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Load firebase-init.mjs first -->
    <script type="module" src="./firebase-init.mjs"></script>
    <!-- Then load your main script -->
    <script type="module" src="./index.mjs"></script>
</head>
<body>
    <div id="user-name"></div>
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="container-box">
        <div class="text-center">
          <div id="patient-id-display" class="mb-4">
            <!-- Patient ID will be displayed here -->
          </div>
          <form id="upload-form" class="mb-4">
            <div class="form-group">
              <div class="custom-file-upload">
                <input type="file" class="form-control-file" id="image-upload" accept="image/*" multiple onchange="previewImages(event)">
                <span id="file-name">Choose files...</span>
              </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="processImages()">Process</button>
          </form>
          <button type="button" class="btn btn-primary mb-4" onclick="viewAllImages()">View All Images</button>
          <div id="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
          <div class="mt-4">
            <h5>Uploaded Images</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th scope="col" class="sticky-column">Preview</th>
                    <th scope="col">File Name</th>
                    <th scope="col">Type</th>
                    <th scope="col">Size</th>
                    <th scope="col">Status</th>
                    <th scope="col">Confidence</th>
                    <th scope="col">Prediction</th>
                    <th scope="col">Heatmap</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody id="image-table-body">
                  <!-- Rows will be dynamically added here -->
                </tbody>
              </table>
            </div>
          </div>
          <button type="button" id="generate-button" class="btn btn-success" style="display: none; margin-top: 20px;" onclick="generateReport()">Generate Report</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Radiology Report Form -->
<div class="container" id="radiology-report-container" style="display: none; margin-top: 20px;">
  <div class="row">
    <div class="col-md-12">
      <form id="radiology-report-form" style="padding: 20px;">
        <div class="card">
          <div class="card-header">
            Radiology Report
          </div>
          <div class="card-body">
            <h5>Patient Information</h5>
            <div class="form-group">
              <label for="patientName">Patient Name</label>
              <input type="text" class="form-control" id="patientName" name="patientName" required>
            </div>
            <div class="form-group">
              <label for="patientDOB">Date of Birth</label>
              <input type="date" class="form-control" id="patientDOB" name="patientDOB" required>
            </div>
            <div class="form-group">
              <label for="patientID">Patient ID</label>
              <input type="text" class="form-control" id="patientID" name="patientID" required>
            </div>
            <div class="form-group">
              <label for="dateOfStudy">Date of Examination</label>
              <input type="date" class="form-control" id="dateOfStudy" name="dateOfStudy" required>
            </div>

            <h5>Examination Details</h5>
            <div class="form-group">
              <label for="typeOfStudy">Type of Study</label>
              <input type="text" class="form-control" id="typeOfStudy" name="typeOfStudy" value="Chest X-ray" readonly>
            </div>
            <div class="form-group">
              <label for="numberOfViews">Number of Views</label>
              <input type="text" class="form-control" id="numberOfViews" name="numberOfViews" required>
            </div>
            <div class="form-group">
              <label for="technique">Technique</label>
              <input type="text" class="form-control" id="technique" name="technique" required>
            </div>

            <h5>Clinical History</h5>
            <div class="form-group">
              <label for="clinicalHistory">Clinical History</label>
              <textarea class="form-control" id="clinicalHistory" name="clinicalHistory" rows="3" required></textarea>
            </div>

            <h5>Findings</h5>
            <div class="form-group mt-2">
              <label for="lungs">Lungs</label>
              <textarea class="form-control" id="lungs" name="lungs" rows="2" placeholder="Overall description of lungs"></textarea>
            </div>
            <div class="form-group">
              <label for="rightLung">Right Lung</label>
              <textarea class="form-control" id="rightLung" name="rightLung" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="leftLung">Left Lung</label>
              <textarea class="form-control" id="leftLung" name="leftLung" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="pleura">Pleura</label>
              <textarea class="form-control" id="pleura" name="pleura" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="airways">Airways</label>
              <textarea class="form-control" id="airways" name="airways" rows="2"></textarea>
            </div>

            <div class="form-group">
              <label for="impression">Impression</label>
              <textarea class="form-control" id="impression" name="impression" rows="3" required></textarea>
            </div>

            <h5>Signature</h5>
            <div class="form-group">
              <label for="radiologistName">Radiologist Name</label>
              <input type="text" class="form-control" id="radiologistName" name="radiologistName" required>
            </div>
            <div class="form-group">
              <label for="radiologistTitle">Radiologist Title</label>
              <input type="text" class="form-control" id="radiologistTitle" name="radiologistTitle" required>
            </div>
            <div class="form-group">
              <label for="reportDate">Report Date</label>
              <input type="date" class="form-control" id="reportDate" name="reportDate" required>
            </div>
            <div style="margin-top: 20px;"></div>
            <button type="button" id="save-report-button" class="btn btn-primary btn-block" onclick="saveReport()">Save Report</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for enlarged image -->
<div id="imageModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="expandedImage">
  <div id="caption"></div>
</div>

<style>
  body {
  background-color: #f8f9fc;
}

.container-box {
  background-color: #ffffff;
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.15);
  border-radius: 0.35rem;
  padding: 20px;
  margin: 20px auto;
  width: 100%;
  overflow-x: auto;
  /* Remove flex properties */
}

.form-group {
  width: 100%;
  max-width: 500px;
  margin: auto;
}

.custom-file-upload {
  position: relative;
  overflow: hidden;
  display: inline-block;
  cursor: pointer;
  color: #fff;
  background-color: #4e73df;
  border-color: #4e73df;
  padding: 10px 20px;
  border-radius: 0.35rem;
  width: 100%;
  max-width: 300px;
  margin: auto;
  text-align: center;
}

.custom-file-upload input[type="file"] {
  position: absolute;
  top: 0;
  right: 0;
  margin: 0;
  padding: 0;
  font-size: 20px;
  cursor: pointer;
  opacity: 0;
}

#file-name {
  margin-left: 10px;
}

img {
  max-width: 100%;
  height: auto;
  object-fit: contain;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1;
  padding-top: 100px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.9);
}

.modal-content {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
}

#caption {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
  text-align: center;
  color: #ccc;
  padding: 10px 0;
  height: 150px;
}

.close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: #bbb;
  text-decoration: none;
  cursor: pointer;
}

.btn-primary {
  background-color: #4e73df;
  border-color: #4e73df;
  border-radius: 0.35rem;
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2653d4;
}

.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.table {
  width: 100%;
  table-layout: auto;
}

th, td {
  white-space: nowrap;
}

.sticky-column {
  position: -webkit-sticky;
  position: sticky;
  left: 0;
  background-color: #ffffff;
  z-index: 2;
}

@media (max-width: 768px) {
  .container-box {
    padding: 10px;
  }
  .table thead {
    display: none;
  }
  .table, .table tbody, .table tr, .table td {
    display: block;
    width: 100%;
  }
  .table tr {
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
    border-radius: 0.35rem;
    padding: 10px;
  }
  .table td {
    text-align: left;
    padding-left: 0;
    position: relative;
    padding: 0.75rem;
    border-top: none;
    display: flex;
    flex-direction: column;
  }
  .table td::before {
    content: attr(data-label);
    font-weight: bold;
    margin-bottom: 5px;
  }
}

.card {
  background-color: #ffffff;
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.15);
  border-radius: 0.35rem;
}

.card-header {
  background-color: #ffffff;
  border-bottom: 1px solid #e3e6f0;
  color: #4e73df !important;
  font-weight: 700;
}

.form-control {
  background-color: #f8f9fc;
  border: 1px solid #d1d3e2;
  color: rgb(133, 135, 150) !important;
  border-radius: 0.35rem;
}

.form-control:focus {
  border-color: #4e73df;
  box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn-primary {
  background-color: #4e73df;
  border-color: #4e73df;
  border-radius: 0.35rem;
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2653d4;
}

label {
  color: rgb(133,135,150);
  font-weight: 600;
}

.btn-block {
  display: block;
  width: 100%;
}

.form-group textarea,
.form-group input[type="text"],
.form-group input[type="date"] {
  padding: 10px;
  margin-bottom: 15px;
  transition: all 0.3s;
}

.form-group textarea:focus,
.form-group input[type="text"]:focus,
.form-group input[type="date"]:focus {
  border-color: #4e73df;
  box-shadow: 0 0 10px rgba(78, 115, 223, 0.1);
}

.card-body h5 {
  color: #4e73df;
  margin-bottom: 20px;
  font-weight: bold;
}
</style>

<script type="module">
import { auth } from './firebase-init.mjs';  // Adjust the path if necessary
  

function getQueryParameter(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// Retrieve the reportId and patientId from the URL
const reportId = getQueryParameter('reportId');
const patientId = getQueryParameter('patientId');

/*
// Hardcoded patientId and reportId for testing purposes
const patientId = "133319";
const reportId = "844a5577-da1e-4367-aaa7-e4bc59795b9a";
*/


// Display the patientId at the top of the page
document.addEventListener('DOMContentLoaded', () => {
    const patientIdDisplay = document.getElementById('patient-id-display');
    if (patientId) {
        patientIdDisplay.innerHTML = `<h3>Patient ID: ${patientId}</h3>`;
    } else {
        patientIdDisplay.innerHTML = `<h3>No Patient ID found.</h3>`;
    }
});

console.log('Report ID:', reportId); // Log the report ID to ensure it's being captured
console.log('Patient ID:', patientId); // Log the patient ID to ensure it's being captured

// Set the patientId in local storage to enforce its use throughout the session
if (patientId) {
    localStorage.setItem('currentPatientId', patientId);
} else {
    alert('No patient ID found. Please go back and enter patient information.');
    window.location.href = 'previous-page.html'; // Redirect to the form page if no patient ID is found
}

  let imageList = []; // Global list to keep track of images and their statuses

// Attach functions to the window object to make them accessible globally
window.previewImages = previewImages;

  function previewImages(event) {
    const files = event.target.files;

    // Append new files to the global image list
    for (const file of files) {
      // Check if the file already exists in the list
      const existingFileIndex = imageList.findIndex(img => img.file.name === file.name);
      if (existingFileIndex === -1) {
        imageList.push({
          file: file,
          status: 'Pending',
          confidence: 'N/A',
          diagnosis: 'N/A',
          heatmap: 'N/A'
        });
      }
    }

    // Render the image list
    renderImageList();
  }

  let fileCounter = 1;

function renderImageList() {
  const tableBody = document.getElementById('image-table-body');
  tableBody.innerHTML = '';

  // Get the patient ID from local storage
  const patientId = localStorage.getItem('currentPatientId');
  
  for (const imgData of imageList) {
    const reader = new FileReader();
    reader.onload = function(e) {
      if (!imgData.customFileName) {
        const date = new Date();
        const dateString = date.toISOString().slice(0, 10).replace(/-/g, '');
        const timeString = date.toTimeString().slice(0, 8).replace(/:/g, '');
        const fileExtension = imgData.file.name.split('.').pop();
        imgData.customFileName = `${patientId}_${String(fileCounter).padStart(2, '0')}_original_${dateString}_${timeString}.${fileExtension}`;
        fileCounter++;
      }
      
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td data-label="Preview"><img src="${e.target.result}" alt="Preview" width="100" onclick="showModal('${e.target.result}')"></td>
        <td data-label="File Name">${imgData.customFileName}</td>
        <td data-label="Type">${imgData.file.type}</td>
        <td data-label="Size">${(imgData.file.size / 1024).toFixed(2)} KB</td>
        <td data-label="Status">${imgData.status}</td>
        <td data-label="Confidence">${imgData.confidence}</td>
        <td data-label="Prediction">${imgData.diagnosis}</td>
        <td data-label="Heatmap">${imgData.heatmap}</td>
        <td data-label="Actions">
          <button class="btn btn-sm btn-primary">View</button>
          <button class="btn btn-sm btn-danger" onclick="removeRow('${imgData.file.name}')">Remove</button>
        </td>
      `;
      tableBody.appendChild(newRow);
    }
    reader.readAsDataURL(imgData.file);
  }
}

window.processImages = processImages

  function processImages() {

    const pendingImages = imageList.filter(img => img.status === 'Pending');
    if (pendingImages.length === 0) {
        alert('No new images to process.');
        return;
    }

    const formData = new FormData();
    for (const imgData of pendingImages) {
        formData.append('images', imgData.file);
    }

    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    fetch('http://localhost:8081/api/pneumonia-detection/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(results => {
        loading.style.display = 'none';

        results.forEach((result, index) => {
            pendingImages[index].status = 'Processed';
            pendingImages[index].confidence = result.confidence ? `${(result.confidence * 100).toFixed(2)}%` : 'N/A';
            pendingImages[index].diagnosis = result.diagnosis || 'N/A';

            // Generate heatmap filename
            const originalFileName = pendingImages[index].customFileName;
            const heatmapFileName = originalFileName.replace('_original_', '_heatmap_');

            pendingImages[index].heatmap = result.heatmap ? `<img src="data:image/jpeg;base64,${result.heatmap}" width="100" alt="Heatmap" onclick="showModal('data:image/jpeg;base64,${result.heatmap}')">` : 'N/A';

            // Save the heatmap filename for backend processing
            pendingImages[index].heatmapFileName = heatmapFileName;
            pendingImages[index].heatmapData = result.heatmap; // Assuming the heatmap data is returned as base64 string

            // Convert the original image to Base64 without affecting display
            encodeToBase64(pendingImages[index].file).then(base64 => {
                pendingImages[index].originalImageData = base64;
            });
        });

        renderImageList();
        checkAllProcessed();
    })
    .catch(error => {
        loading.style.display = 'none';
        alert('An error occurred while processing the images.');
        console.error('Error:', error);
    });
}

function encodeToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); // Get the base64 part
        reader.onerror = error => reject(error);
    });

    
}
 

  function checkAllProcessed() {
    const allProcessed = imageList.every(img => img.status === 'Processed');
    if (allProcessed) {
      document.getElementById('generate-button').style.display = 'block';
    }
  }

  function removeRow(fileName) {
    imageList = imageList.filter(img => img.file.name !== fileName);
    renderImageList();
    checkAllProcessed();
  }

  function showModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const expandedImage = document.getElementById('expandedImage');
    expandedImage.src = imageSrc;
    modal.style.display = 'block';
  }

  function closeModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
  }

window.generateReport = generateReport
  function generateReport() {
        const patientId = localStorage.getItem('currentPatientId'); // Adjust this line as necessary

        if (patientId) {
            fetch(`http://localhost:8081/api/patient/search?patientId=${patientId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        document.getElementById('patientName').value = data.fullName || '';
                        document.getElementById('patientDOB').value = data.dob || '';
                        document.getElementById('patientID').value = data.patientId || '';
                        document.getElementById('upload-form').style.display = 'none';
                        document.getElementById('generate-button').style.display = 'none';
                        document.getElementById('radiology-report-container').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error fetching patient data:', error));
        } else {
            alert('No patient ID found. Please go back and enter patient information.');
            window.location.href = 'previous-page.html'; // Redirect to the form page if no patient ID is found
        }
    }

   // Function to save images and get their folder URLs from the backend
function saveImagesAndGetUrls() {
    const patientId = localStorage.getItem('currentPatientId');
    const processedImages = imageList.filter(img => img.status === 'Processed');
    if (processedImages.length === 0) {
        alert('No processed images to save.');
        return Promise.reject('No processed images to save.');
    }

    const imagesData = processedImages.map(imgData => ({
        originalImage: imgData.originalImageData,
        heatmapData: imgData.heatmapData,
        customFileName: imgData.customFileName,
        heatmapFileName: imgData.heatmapFileName
    }));

    const payload = JSON.stringify(imagesData);

    // The backend will generate the reportName and return it along with folder URLs
    return fetch(`http://localhost:8081/api/uploads/save-images?patientId=${patientId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: payload
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error('Failed to save images: ' + JSON.stringify(err));
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Images saved successfully:', data);
        return data; // Return the data containing reportName and folder URLs
    })
    .catch(error => {
        alert('An error occurred while saving the images.');
        console.error('Error:', error);
        return Promise.reject(error);
    });
}

function formatDate(dateString) {
    const [year, month, day] = dateString.split('-');
    return `${month}/${day}/${year}`;
}

window.saveReport = saveReport

function saveReport() {
    saveImagesAndGetUrls().then(({ reportName, folderPaths }) => {
        localStorage.setItem('currentReportName', reportName);

        const formattedReportDate = formatDate(document.getElementById('reportDate').value);
        const formattedDateOfStudy = formatDate(document.getElementById('dateOfStudy').value);

        const reportData = {
            reportId: reportId,  // Use the global reportId here
            reportDate: formattedReportDate,
            radiologistName: document.getElementById('radiologistName').value,
            radiologistTitle: document.getElementById('radiologistTitle').value,
            patientName: document.getElementById('patientName').value,
            patientDOB: document.getElementById('patientDOB').value,
            patientID: localStorage.getItem('currentPatientId'),  // Use the patient ID from localStorage
            dateOfStudy: formattedDateOfStudy,
            typeOfStudy: document.getElementById('typeOfStudy').value,
            numberOfViews: document.getElementById('numberOfViews').value,
            technique: document.getElementById('technique').value,
            clinicalHistory: document.getElementById('clinicalHistory').value,
            lungs: document.getElementById('lungs').value,
            rightLung: document.getElementById('rightLung').value,
            leftLung: document.getElementById('leftLung').value,
            pleura: document.getElementById('pleura').value,
            airways: document.getElementById('airways').value,
            impression: document.getElementById('impression').value,
            imageFolderUrls: folderPaths,
            reportName: reportId,
            created_at: new Date().toISOString()
        };

        fetch(`http://localhost:8081/api/patient/saveReport?patientId=${reportData.patientID}&reportId=${reportId}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(reportData),
})
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Report saved successfully:', data);
            finalizeInProgressReport(reportId, reportData.patientID);  // Finalize the in-progress report using the global reportId
            window.location.href = `Dedicated-Report-Page.html?patientId=${reportData.patientID}&reportId=${reportId}`;
        })
        .catch(error => {
            console.error('Error saving report:', error);
            alert('An error occurred while saving the report.');
        });
    });
}
 

// Attach other functions to the window object as needed

// Continue doing this for any other functions you need to access globally

function finalizeInProgressReport(reportId, patientId) {
    console.log('Finalizing in-progress report with ID:', reportId, 'for patient:', patientId);

    const user = auth.currentUser;

    if (user) {
        const userId = user.uid; // Fetch the userId from the currently authenticated user
        console.log('Authenticated user ID:', userId);

        fetch(`http://localhost:8081/api/patient/finalizeInProgressReport`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reportId, patientId, userId }), // Include userId in the request body
        })
        .then(response => {
            console.log('Received response:', response);
            if (!response.ok) {
                throw new Error(`Failed to finalize the in-progress report: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('In-progress report finalized successfully:', data);
            // Proceed to the next step if necessary
        })
        .catch(error => {
            console.error('Error finalizing in-progress report:', error.message);
            console.error('Stack trace:', error.stack); // Log stack trace
            alert('An error occurred while finalizing the in-progress report.');
        });
    } else {
        console.error('User is not signed in.');
        alert('No user is signed in. Please sign in to finalize the report.');
    }
}

</script>

<body>
</html>


</div>
                    </div>
                </div>
                <div class="container">
                    <h1></h1>
                </div>
                <div class="row">
                    <div class="col"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/firebase-auth.mjs" type="module"></script>
    <script src="assets/js/firebase-init.mjs" type="module"></script>
    <script src="assets/js/index.mjs" type="module"></script>
    <script src="assets/js/logout.mjs" type="module"></script>
    <script src="assets/js/theme.js"></script>
</body>

</html>